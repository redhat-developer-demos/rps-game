<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/chota@latest">
  <link rel="stylesheet" href="progressjs.min.css">
  <style>
    :root {
      --bg-color: #ffffff;
      --bg-secondary-color: #f3f3f6;
      --color-primary: #14854F;
      --color-lightGrey: #d2d6dd;
      --color-grey: #747681;
      --color-darkGrey: #3f4144;
      --color-error: #d43939;
      --color-success: #28bd14;
      --grid-maxWidth: 120rem;
      --grid-gutter: 2rem;
      --font-size: 1.6rem;
      --font-color: #333333;
      --font-family-sans: sans-serif;
      --font-family-mono: monaco, "Consolas", "Lucida Console", monospace;
    }

    body.dark {
      --bg-color: #000;
      --bg-secondary-color: #131316;
      --font-color: #f5f5f5;
      --color-grey: #ccc;
      --color-darkGrey: #777;
    }

    button.warn {
      background-color: orange;
    }

    .progressjs-theme-blue .progressjs-inner {
      height: 100vh;
      background-color: #747681;
    }
    .progressjs-progress {
      z-index: -1 !important;
    }
  </style>
  <title>Roshambo Admin Panel</title>
</head>

<body>
  <br>
  <main class="container">
    <h1>Roshambo Admin Panel</h1>

    <button id="start-btn" onclick="startGame()" type="button" class="button primary icon">Start Game ðŸš€</button>
    <button disabled id="next-btn" onclick="advanceRound()" type="button" class="button warn icon">Advance Round ðŸš¦</button>
  </main>

  <script src="progress.min.js"></script>
  <script>
    if (window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('dark');
    }
  </script>
  <script>
    let progress = null
    let progressTimer = null
    let topPlayers = null
    
    const ENDPOINTS = {
      GAME_START: '/admin/game/start',
      GAME_CONTINUE: '/admin/game/continue'
    }

    // ENABLE, DISABLE, END are the event names used for the game UI
    // These are replaced with different names for admin...
    const SSE_TYPE = {
      ENABLE: 'start',
      DISABLE: 'stop',
      END: 'end',
      TOP: 'top'
    }
    const startBtn = document.getElementById('start-btn')
    const nextBtn = document.getElementById('next-btn')

    function startGame() {
      startBtn.setAttribute('disabled', true)

      fetch(ENDPOINTS.GAME_START)
        .then((res) => {
          if (res.status !== 200) {
            throw new Error(`expected 200 response from ${ENDPOINTS.GAME_START}`)
          }
        })
        .catch((err) => {
          alert('Failed to start game. Check the console for error logs.')
          log(err)
          startBtn.removeAttribute('disabled')
        })
    }

    function advanceRound() {
      nextBtn.setAttribute('disabled', true)

      fetch(ENDPOINTS.GAME_CONTINUE)
        .then((res) => {
          if (res.status !== 200) {
            throw new Error(`expected 200 response from ${ENDPOINTS.GAME_CONTINUE}`)
          }
        })
        .catch((err) => {
          alert('Failed to advance game. Check the console for error logs.')
          log(err)
          nextBtn.removeAttribute('disabled')
        })
    }

    function log (...args) {
      args.unshift(`${new Date().toLocaleString()}: `)

      console.log.apply(console, args)
    }

    function startProgress ({ lengthOfRoundInSeconds }) {
      progress = progressJs().start()
      progressTimer = setInterval(() => {
        progressJs().increase(100 / lengthOfRoundInSeconds)
      }, 1000)
    }

    function endProgress () {
      if (progressTimer) {
        clearInterval(progressTimer)
        progress.end()
      }
    }

    async function getCurrentStatus () {
      const res = await fetch('/game/state')
      const { status } = await res.json()

      // For some reason the SSE is lowercase but this is uppercase...
      return status.toLowerCase()
    }

    function processSSE ({ type, content }) {
      log('SSE Type and Content', type, content)
      endProgress()
      
      if (type === SSE_TYPE.ENABLE) {
        nextBtn.setAttribute('disabled', true)
        startProgress(content)
      } else if (type === SSE_TYPE.DISABLE) {
        nextBtn.removeAttribute('disabled')
      } else if (type === SSE_TYPE.END) {
        nextBtn.setAttribute('disabled', true)
        startBtn.removeAttribute('disabled')
      } else if (type === SSE_TYPE.TOP) {
        topPlayers = content.topPlayers
      } else {
        alert(`Received uknown SSE message type "${type}". Check the DevTools console for details.`)
      }
    }

    async function initialiseEventStream() {
      return new Promise((resolve, reject) => {
        const es = new EventSource('/admin/stream')

        es.addEventListener('close', () => {
          alert('Lost connection to server. Reloading the page...')
          window.location.reload()
        })

        es.addEventListener('error', (event) => {
          log('Error event on SSE', event)
          es.close()
        })

        es.addEventListener('open', () => {
          log('Established SSE connection')
          resolve()
        })

        es.addEventListener('message', (event) => {
          log('Received SSE message', event)

          try {
            processSSE(JSON.parse(event.data))
          } catch (e) {
            log('Error parsing SSE payload', event)
          }
        })
      })

    }

    (async function main() {
      await initialiseEventStream()

      const startingStatus = await getCurrentStatus()
      console.log('starting statis', startingStatus)
      if (startingStatus === SSE_TYPE.DISABLE) {
        startBtn.setAttribute('disabled', true)
        nextBtn.removeAttribute('disabled')
      } else if (startingStatus === SSE_TYPE.ENABLE) {
        startBtn.setAttribute('disabled', true)
        nextBtn.setAttribute('disabled', true)
      } else {
        startBtn.removeAttribute('disable', true)
        nextBtn.setAttribute('disable', true)
      }

    })()
  </script>
</body>

</html>
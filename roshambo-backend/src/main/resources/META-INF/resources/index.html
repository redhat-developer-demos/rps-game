<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    button[disabled] {
      background: gray;
      opacity: 0.5;
    }
  </style>
  <title>Roshambo Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900">
  <div class="grid grid-cols-4">
    <!-- Left pane -->
    <div class="col-span-1 p-2 h-screen">
      <div class="grid grid-rows-2 h-full py-3">
        <div class="grid grid-rows-2">
          <h2 class="text-3xl text-white text-center">Roshambo Admin</h2>
        </div>
        <div class="flex flex-col align-end justify-end">
          <div class="flex items-center">
            <div class="flex-1 ">
              <h3 class="text-2xl bold text-white text-center">Round Timer</h3>
              <pre id="countdown" class="flex-1 text-2xl bold text-white text-center">30</pre>
            </div>
          </div>
          <button
            id="start-btn"
            onclick="startGame()"
            type="button"
            class="grow-0 m-3 bg-green-500 rounded p-3 text-xl primary text-white icon">Start Game ðŸš€</button>
          <button
            disabled
            id="next-btn"
            onclick="advanceRound()"
            type="button"
            class="grow-0 m-3 bg-orange-500 rounded p-3 text-xl primary text-white icon">Advance Round ðŸš¦</button>
        </div>
      </div>
    </div>
    <!-- Right pane -->
    <div class="col-span-3">
      <div class="grid grid-cols-2">
        <div class="h-screen p-7">
          <div class="bg-red-500 h-full text-center w-full rounded">
            <h2 class="text-white text-2xl pt-3">Team #1</h2>
            <ul class="text-white text-xl pt-4" id="top-players"></ul>
          </div>
        </div>
        <div class="h-screen p-7">
          <div class="bg-blue-500 h-full text-center w-full rounded">
            <h2 class="text-white text-2xl pt-3">Team #2</h2>
            <ul class="text-white text-xl pt-4" id="top-players"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    let topPlayers = null
    let gameConfig = null
    const timerEl = document.getElementById('countdown')

    const ENDPOINTS = {
      GAME_START: '/admin/game/start',
      GAME_CONTINUE: '/admin/game/continue'
    }

    // ENABLE, DISABLE, END are the event names used for the game UI
    // These are replaced with different names for admin...
    const SSE_TYPE = {
      ENABLE: 'start',
      DISABLE: 'stop',
      END: 'end',
      TOP: 'top'
    }
    const startBtn = document.getElementById('start-btn')
    const nextBtn = document.getElementById('next-btn')

    function startGame() {
      startBtn.setAttribute('disabled', true)

      fetch(ENDPOINTS.GAME_START)
        .then((res) => {
          if (res.status !== 200) {
            throw new Error(`expected 200 response from ${ENDPOINTS.GAME_START}`)
          }
        })
        .catch((err) => {
          alert('Failed to start game. Check the console for error logs.')
          log(err)
          startBtn.removeAttribute('disabled')
        })
    }

    function advanceRound() {
      nextBtn.setAttribute('disabled', true)

      fetch(ENDPOINTS.GAME_CONTINUE)
        .then((res) => {
          if (res.status !== 200) {
            throw new Error(`expected 200 response from ${ENDPOINTS.GAME_CONTINUE}`)
          }
        })
        .catch((err) => {
          alert('Failed to advance game. Check the console for error logs.')
          log(err)
          nextBtn.removeAttribute('disabled')
        })
    }

    function log (...args) {
      args.unshift(`${new Date().toLocaleString()}: `)

      console.log.apply(console, args)
    }

    async function getCurrentStatus () {
      const res = await fetch('/game/state')
      const { status } = await res.json()

      // For some reason the SSE is lowercase but this is uppercase...
      return status.toLowerCase()
    }

    async function getConfig () {
      const res = await fetch('/game/init')
      const { configuration } = await res.json()

      return configuration
    }

    function updateCountdown (msTimeElapsed) {
      const now = Date.now()
      const { roundTimeInSeconds } = gameConfig
      const totalRoundTimeMs = roundTimeInSeconds * 1000

      if (typeof msTimeElapsed === 'undefined') {
        msTimeElapsed = 0
      }
      
      const remainingTimeMs = totalRoundTimeMs - msTimeElapsed
      if (remainingTimeMs <= 0) {
        timerEl.innerHTML = roundTimeInSeconds
        return
      }

      const remainingTime = (remainingTimeMs / 1000).toFixed(3)
      timerEl.innerHTML = remainingTime
      
      setTimeout(() => {
        updateCountdown(msTimeElapsed + Math.abs(now - Date.now()))
      }, Math.round(1000 / 60))
    }

    function renderTopPlayers() {
      const el = document.getElementById('top-players')

      topPlayers.forEach(player => {
        const li = document.createElement('li')
        li.textContent = player
        el.appendChild(li)
      })
    }

    function processSSE ({ type, content }) {
      log('SSE Type and Content', type, content)
      
      if (type === SSE_TYPE.ENABLE) {
        nextBtn.setAttribute('disabled', true)
        updateCountdown()
      } else if (type === SSE_TYPE.DISABLE) {
        nextBtn.removeAttribute('disabled')
      } else if (type === SSE_TYPE.END) {
        nextBtn.setAttribute('disabled', true)
        startBtn.removeAttribute('disabled')
        renderTopPlayers()
      } else if (type === SSE_TYPE.TOP) {
        topPlayers = content.topPlayers
      } else {
        console.log(`Received uknown SSE message type "${type}". Content was:`, content)
      }
    }

    async function initialiseEventStream() {
      return new Promise((resolve, reject) => {
        const es = new EventSource('/admin/stream')

        es.addEventListener('close', () => {
          alert('Lost connection to server. Reloading the page...')
          window.location.reload()
        })

        es.addEventListener('error', (event) => {
          log('Error event on SSE', event)
          es.close()
        })

        es.addEventListener('open', () => {
          log('Established SSE connection')
          resolve()
        })

        es.addEventListener('message', (event) => {
          log('Received SSE message', event)

          try {
            processSSE(JSON.parse(event.data))
          } catch (e) {
            log('Error parsing SSE payload', event)
            log(e)
          }
        })
      })

    }

    (async function main() {
      gameConfig = await getConfig()

      // Set the round timer to the backend configured value
      timerEl.innerHTML = gameConfig.roundTimeInSeconds.toFixed(3)

      // Connect to SSE
      await initialiseEventStream()

      const startingStatus = await getCurrentStatus()
      
      if (startingStatus === SSE_TYPE.DISABLE) {
        startBtn.setAttribute('disabled', true)
        nextBtn.removeAttribute('disabled')
      } else if (startingStatus === SSE_TYPE.ENABLE) {
        startBtn.setAttribute('disabled', true)
        nextBtn.setAttribute('disabled', true)
      } else {
        startBtn.removeAttribute('disable', true)
        nextBtn.setAttribute('disable', true)
      }

    })()
  </script>
</body>

</html>